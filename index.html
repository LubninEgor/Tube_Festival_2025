<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Tube Festival 2025</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.0/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: white; display: flex; justify-content: center;
            align-items: center; flex-direction: column; z-index: 10000;
        }
        .arjs-loader { height: 100px; width: 100px; }
        .progress-bar { width: 300px; height: 20px; background: #333; margin-top: 20px; }
        .progress-fill { height: 100%; background: #0f0; width: 0%; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="arjs-loader">
            <svg viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" stroke="#fff" stroke-width="10" fill="none" stroke-dasharray="283" stroke-dashoffset="75">
                    <animate attributeName="stroke-dashoffset" dur="2s" repeatCount="indefinite" from="283" to="0"/>
                </circle>
            </svg>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div id="statusText">Загрузка ресурсов...</div>
    </div>

    <a-scene 
        vr-mode-ui="enabled: false"
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; maxDetectionRate: 30;"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
    >
        <!-- Используем pattern-маркер для простоты -->
        <a-marker 
            type="pattern" 
            preset="custom"
            url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.patt"
        >
            <!-- Модель с вашего GitHub -->
            <a-entity 
                id="mainModel"
                gltf-model="https://raw.githubusercontent.com/LubninEgor/Tube_Festival_2025/main/assets/model.glb"
                scale="0.5 0.5 0.5"
                position="0 0.5 0"
                animation-mixer="clip: *; loop: repeat;"
                shadow="cast: true; receive: false"
            ></a-entity>
        </a-marker>
        
        <!-- Статическое окружение -->
        <a-entity environment="preset: default; ground: hills; dressingAmount: 25"></a-entity>
        
        <!-- Источники света -->
        <a-entity light="type: ambient; color: #888; intensity: 0.6"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="-1 3 1"></a-entity>
        
        <!-- Камера -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Фикс для GitHub Raw Content
        const fixRawGithubUrl = (url) => {
            if(url.includes('raw.githubusercontent.com')) {
                return url.replace('raw.githubusercontent.com', 'rawcdn.githack.com');
            }
            return url;
        };

        // Конфигурация
        const MODEL_URL = fixRawGithubUrl('https://raw.githubusercontent.com/LubninEgor/Tube_Festival_2025/main/assets/model.glb');
        const MARKER_URL = 'https://raw.githack.com/AR-js-org/AR.js/master/data/images/hiro.patt';

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            const scene = document.querySelector('a-scene');
            const statusText = document.getElementById('statusText');
            const progressFill = document.getElementById('progressFill');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            // Установка модели и маркера
            document.querySelector('[gltf-model]').setAttribute('gltf-model', `url(${MODEL_URL})`);
            document.querySelector('a-marker').setAttribute('url', MARKER_URL);
            
            // Обработчики событий
            scene.addEventListener('loaded', () => {
                statusText.textContent = "Сцена загружена";
                simulateProgress(100);
                setTimeout(() => {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 500);
                }, 1000);
            });
            
            scene.addEventListener('error', (e) => {
                statusText.textContent = `Ошибка: ${e.detail.error}`;
                console.error('AR Scene Error:', e.detail.error);
            });
            
            // Загрузка модели
            const model = document.getElementById('mainModel');
            model.addEventListener('model-loaded', () => {
                statusText.textContent = "3D модель загружена";
                simulateProgress(80);
            });
            
            model.addEventListener('model-error', (e) => {
                statusText.textContent = "Ошибка загрузки модели";
                console.error('Model Error:', e.detail);
            });
            
            // Загрузка маркера
            const marker = document.querySelector('a-marker');
            marker.addEventListener('markerFound', () => {
                statusText.textContent = "Маркер распознан";
            });
            
            // Симуляция прогресса
            function simulateProgress(target) {
                let current = parseInt(progressFill.style.width) || 0;
                const interval = setInterval(() => {
                    current = Math.min(current + 2, target);
                    progressFill.style.width = `${current}%`;
                    
                    if(current >= target) {
                        clearInterval(interval);
                    }
                }, 50);
            }
            
            simulateProgress(40);
        });
        
        // Компонент для работы с тенями
        AFRAME.registerComponent('shadow', {
            schema: {
                cast: {type: 'boolean', default: false},
                receive: {type: 'boolean', default: false}
            },
            init: function() {
                this.el.addEventListener('model-loaded', () => {
                    const mesh = this.el.getObject3D('mesh');
                    if(mesh) {
                        mesh.traverse(node => {
                            if(node.isMesh) {
                                node.castShadow = this.data.cast;
                                node.receiveShadow = this.data.receive;
                            }
                        });
                    }
                });
            }
        });
        
        // Адаптация для iOS
        if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            document.querySelector('a-scene').setAttribute('arjs', 'sourceWidth: 1280; sourceHeight: 720;');
        }
    </script>
</body>
</html>